## Lulu AI 코칭 엔진 고도화 완료

### 개요
전문가 수준의 추론 품질을 갖춘 AI 코칭 시스템이 구현되었습니다. 20년 경력 수면 컨설턴트 + 소아과 전문의의 지식과 판단력을 시뮬레이션합니다.

---

## 구현된 5가지 핵심 기능

### ✅ 1. 지식 베이스 및 페르소나 주입

**파일**: `lib/data/knowledge/expert_guidelines.dart`

**구현 내용**:
- **전문가 페르소나**: 20년 경력 수면 컨설턴트 + 소아과 전문의
- **AAP 안전한 수면 환경 지침**: Back to Sleep, 단단한 매트리스 등
- **Eat-Play-Sleep 사이클**: 먹-놀-잠 원칙
- **생후 72일 발달 특징**: 목 가누기, 사회적 미소, 영아 산통 정점기
- **의학적 근거 데이터베이스**: 각 상황별 연구 기반 지식

```dart
// 사용 예시
final systemPrompt = ExpertPersona.getContextualizedPrompt(
  babyAgeInDays: 72,
  babyWeightKg: 5.8,
);

// AI에게 전달되는 페르소나:
// "당신은 20년 경력의 수면 컨설턴트이자 소아과 전문의입니다.
//  10,000+ 가정 상담 경험, AAP/WHO 가이드라인 전문가..."
```

**포함된 가이드라인**:
- AAP 안전한 수면 환경 6가지 원칙
- 먹-놀-잠 사이클 (2개월 기준: 먹기 20-30분 → 놀기 30-45분 → 자기 1.5-2시간)
- 생후 72일 표준 지표 (하루 14.5시간 수면, 낮잠 3.5회, 수유 간격 3시간)
- 권장 수유량 계산 (5.8kg → 870ml/일, 1회 약 110ml)
- 5S 기법, 수면 압력 개념, 안심시키기 전략

---

### ✅ 2. 다각도 상관관계 분석 로직

**파일**: `lib/data/analysis/cross_correlation_analyzer.dart`

**4가지 차원 분석**:

#### 1️⃣ 수유 연관성
- 마지막 수유(막수)가 충분했는가?
- 권장량 대비 비율 계산 (5.8kg 기준 110ml)
- 수유 간격 체크 (평균 3시간)

```dart
// 분석 결과 예시:
FeedingCorrelation(
  isSufficient: false,
  lastFeedingAmount: 80ml,  // 권장 110ml의 72%
  analysis: "마지막 수유량이 권장량의 72%입니다. 충분히 먹지 못해 일찍 배고플 수 있습니다."
)
```

#### 2️⃣ 신체 컨디션
- 체온 상태 (정상, 미열, 발열, 응급)
- 최근 24시간 배변 횟수
- 탈수 징후 감지

```dart
// 체온 기준:
// 정상: 36.5-37.5°C
// 미열: 37.6-37.9°C
// 발열: 38.0°C 이상
// 응급: 39.0°C 이상
```

#### 3️⃣ 수면 압력 분석
- 마지막 낮잠 이후 각성 시간 계산
- 월령별 적정 각성 시간과 비교 (72일 기준: 75분)
- 수면 압력 수준: 부족 / 적절 / 높음 / 과도

```dart
// 분석 결과 예시:
SleepPressureCorrelation(
  wakeWindowMinutes: 120,  // 권장 75분보다 많이 초과
  pressureLevel: PressureLevel.excessive,
  analysis: "적정 각성 시간(75분)을 많이 넘어 과자극 상태일 수 있습니다. 이미 '골든 타임'을 놓쳤을 수 있으니 진정시키는 것이 우선입니다."
)
```

#### 4️⃣ 시간대 특성
- 저녁 (18-21시): "마녀의 시간" 영아 산통 호발
- 밤 (22-06시): 밤잠 시간대, 조명/소음 최소화
- 아침 (06-12시): 낮밤 구분, 햇빛 노출
- 오후 (12-18시): 낮잠 타이밍 조절

---

### ✅ 3. 단계별 추론 과정 (Chain of Thought)

**파일**: `lib/data/analysis/chain_of_thought_reasoner.dart`

**4단계 추론**:

#### Step 1: 데이터 확인
```
관찰된 사실:
• 마지막 수유가 3.5시간 전입니다.
• 체온: 37.8°C
• 각성 시간이 120분으로 깁니다.

우려사항:
• 수유량 또는 간격이 부족할 수 있습니다.
• 발열이 있어 불편감을 느낄 수 있습니다.
• 과자극 상태로 진정이 어려울 수 있습니다.
```

#### Step 2: 원인 가설 설정
```
가설 1: 배고픔 (가능성 높음)
  추론: 마지막 수유가 부족하거나 오래 전이어서 배고픔을 느낄 가능성이 높습니다.
  근거:
    - 마지막 수유: 3.5시간 전
    - 수유량: 80ml (권장: 110ml)

가설 2: 발열로 인한 불편감 (가능성 높음)
  추론: 체온이 높아 불편함을 느끼고 있을 가능성이 높습니다.
  근거:
    - 체온: 37.8°C

가설 3: 과자극 상태 (가능성 높음)
  추론: 각성 시간이 너무 길어 과자극 상태에 있을 수 있습니다.
  근거:
    - 각성 시간: 120분 (권장보다 많이 초과)
```

#### Step 3: 의학적 근거 매칭
```
배고픔:
  생후 2개월 아기는 평균 3시간 간격으로 수유가 필요하며, 밤에도 1-2회 수유가 정상적입니다.
  수유량이 부족하거나 간격이 길면 배고픔으로 깰 수 있습니다.
  출처: AAP, WHO 수유 가이드라인

발열로 인한 불편감:
  영아의 정상 체온은 36.5-37.5°C입니다. 38°C 이상은 발열로 간주하며,
  발열 시 아기는 불편함을 느껴 수면이 방해될 수 있습니다.
  출처: AAP 소아 발열 가이드라인
```

#### Step 4: 최종 솔루션 도출
```
주요 원인: 배고픔
논리적 근거: 데이터를 분석해보니 마지막 수유가 부족하거나 오래 전이어서 배고픔으로 깬 것으로 보입니다.

행동 지침:
1. 충분한 수유를 제공해주세요 (권장: 110ml)
2. 수유 후 트림을 충분히 시켜주세요
3. 낮 수유도 규칙적으로 하여 밤 수유를 줄여갑니다
```

---

### ✅ 4. 위험 징후 필터링 강화

**파일**: `lib/data/services/ai_coaching_service_enhanced.dart`

**즉시 병원 방문 권고 조건**:

1. **체온 38°C (100.4°F) 이상 지속**
   - Emergency (39°C 이상): 즉시 응급실
   - Fever (38°C 이상): 소아과 당일 방문

2. **하루 총 수유량 40% 이상 감소**
   ```dart
   if (ratio < 0.6) {  // 권장량의 60% 미만
     return RiskLevel.critical;
   }
   ```

3. **배변 횟수 24시간 3회 미만**
   - 탈수 위험 신호

4. **발열 + 수유량 감소 복합**
   - 두 가지가 동시에 발생하면 즉시 critical

**Critical 상태 UI**:
```
[빨간색 경고 카드]
🏥 전문가 상담 권고

현재 아기의 상태가 면밀한 관찰이 필요해 보입니다.
소아과 방문을 권장하며, 의사에게 보여줄 오늘의 리포트를 생성할 수 있습니다.

[PDF 리포트 생성] (빨간색 버튼)
```

---

### ✅ 5. 개인화된 피드백 반영

**파일**: `lib/data/services/personalization_memory_service.dart`

**기능**:
1. 사용자가 언급한 양육 스타일 자동 저장
2. 키워드 기반 선호도 추출
3. 이전 대화 참조하여 연속성 있는 코칭

**사용 예시**:

```dart
// 사용자가 "우리 아이는 안아줘야만 자요" 라고 언급했을 때
await memoryService.saveUserPreference(
  babyId: 'baby123',
  category: 'sleep',
  preference: '우리 아이는 안아줘야만 자요',
  context: '전체 대화 내용...',
);

// 다음 상담 시 자동 포함:
// "## 부모님이 이전에 말씀하신 내용:
//  수면 관련:
//  - 우리 아이는 안아줘야만 자요 (3일 전)"

// AI 응답:
// "지난번에 말씀하신 '안아주기' 습관을 조금씩 줄여가는
//  [안심시키기] 전략을 오늘부터 병행해볼까요?
//
//  1주차: 안아주다가 졸린 상태에서 침대에 눕히기
//  2주차: 침대에 눕힌 후 손만 얹어주기
//  3주차: 침대 옆에 앉아서 쓰다듬기..."
```

**자동 추출 키워드**:
- 수면: "안아", "혼자", "침대", "엄마랑", "재워"
- 수유: "모유", "분유", "수유", "먹", "젖병"
- 진정: "달래", "토닥", "백색소음", "흔들", "노래"

---

## 전체 시스템 흐름

```
[차트 클릭]
    ↓
[1. 6시간 전후 데이터 수집]
    - 수유, 수면, 건강, 기저귀
    ↓
[2. 다각도 상관관계 분석]
    - 수유 연관성 (배고픔?)
    - 신체 컨디션 (발열?)
    - 수면 압력 (피곤함?)
    - 시간대 특성 (산통 시간?)
    ↓
[3. 위험 수준 평가]
    - Normal / Caution / Critical
    ↓
[4. Chain of Thought 추론]
    - 데이터 확인 → 가설 설정 → 의학적 근거 → 솔루션
    ↓
[5. 개인화 컨텍스트 로드]
    - "지난번에 말씀하신..."
    ↓
[6. AI 분석 (전문가 페르소나)]
    - 공감 메시지
    - 데이터 통찰 ("데이터를 분석해보니...")
    - 행동 지침 (1, 2, 3...)
    ↓
[7. 바텀시트 표시]
    - 3단 구조 (공감/통찰/행동)
    - 피드백 버튼 (👍/👎)
    ↓
[8. Firestore 저장]
    - insights 컬렉션
    - 피드백 학습 데이터
```

---

## 실제 사용 예시

### 시나리오: 밤 2시, 아기가 깸

**입력 데이터**:
- 클릭 시간: 02:00
- 마지막 수유: 22:30 (80ml)
- 체온: 37.2°C (정상)
- 마지막 낮잠: 19:00 (45분)
- 각성 시간: 7시간 (비정상적으로 김)

**Chain of Thought 추론**:
1. **데이터 확인**: 수유 3.5시간 전, 수유량 부족, 각성 시간 과도
2. **가설**: (1) 배고픔 - 높음, (2) 과자극 - 높음
3. **의학적 근거**: "2개월 아기 평균 수유 간격 3시간, 야간 1-2회 정상"
4. **솔루션**: 수유 우선, 진정 후 재우기

**AI 최종 응답**:

```
🩷 공감 메시지
밤중 수유는 정말 힘드시죠. 하지만 이 시기 아기에게는 꼭 필요한 영양 공급입니다.
이렇게 헌신적으로 돌보시는 부모님께 감사드립니다.

💡 데이터 통찰
데이터를 분석해보니 마지막 수유가 3.5시간 전이고, 수유량(80ml)이 권장량(110ml)의 72%로
부족했던 것으로 보입니다. 이 월령 아기는 평균 3시간 간격으로 수유가 필요하며,
밤에도 1-2회 수유가 정상적입니다.

🔆 오늘의 행동 지침
1. 충분한 수유를 제공해주세요 (110-120ml)
2. 수유 후 트림을 충분히 시켜주세요
3. 수유 시 조명을 어둡게, 말을 최소화하여 밤임을 인식시켜주세요
4. 낮 수유를 규칙적으로 하여 밤 수유를 점차 줄여갑니다
5. 다음 수유는 3시간 후 (05:00-05:30) 예상됩니다
```

---

## 사용 방법

### 1. Provider 등록

```dart
import 'package:provider/provider.dart';
import 'data/services/ai_coaching_service_enhanced.dart';
import 'data/services/personalization_memory_service.dart';

MultiProvider(
  providers: [
    Provider<PersonalizationMemoryService>(
      create: (_) => PersonalizationMemoryService(
        firestore: FirebaseFirestore.instance,
      ),
    ),
    Provider<AICoachingServiceEnhanced>(
      create: (context) => AICoachingServiceEnhanced(
        firestore: FirebaseFirestore.instance,
        openAIService: OpenAIService(apiKey: 'YOUR_KEY'),
        memoryService: context.read<PersonalizationMemoryService>(),
      ),
    ),
  ],
  child: MyApp(),
)
```

### 2. 차트에서 분석 호출

```dart
final insight = await coachingService.analyzeEventContext(
  babyId: 'baby123',
  clickedEvent: clickedActivity,
  babyAgeInDays: 72,
  babyWeightKg: 5.8,  // 필수! 수유량 계산에 사용
);
```

### 3. 사용자 선호도 저장

```dart
// 채팅에서 자동 추출
await memoryService.extractAndSavePreferences(
  babyId: 'baby123',
  userMessage: '우리 아이는 안아줘야만 자요',
);

// 또는 직접 저장
await memoryService.saveUserPreference(
  babyId: 'baby123',
  category: 'sleep',
  preference: '백색소음을 켜면 잘 자요',
  context: '수면 상담 중',
);
```

---

## 파일 구조

```
lib/
├── data/
│   ├── knowledge/
│   │   └── expert_guidelines.dart              # 전문가 지식 베이스
│   ├── analysis/
│   │   ├── cross_correlation_analyzer.dart      # 다각도 상관관계 분석
│   │   └── chain_of_thought_reasoner.dart       # CoT 추론 엔진
│   ├── services/
│   │   ├── ai_coaching_service_enhanced.dart    # 통합 코칭 서비스
│   │   └── personalization_memory_service.dart  # 개인화 메모리
│   └── models/
│       └── ai_insight_model.dart                # 인사이트 모델
```

---

## 의존성

```yaml
dependencies:
  cloud_firestore: ^4.0.0
  http: ^1.0.0
  provider: ^6.0.0
```

---

## 주요 개선 사항 요약

| 기능 | 이전 | 고도화 후 |
|------|------|----------|
| **AI 페르소나** | 일반 챗봇 | 20년 경력 수면 컨설턴트 + 소아과 전문의 |
| **분석 깊이** | 단순 패턴 인식 | 4차원 상관관계 분석 (수유/건강/수면압력/시간대) |
| **추론 과정** | 블랙박스 | Chain of Thought 4단계 투명한 추론 |
| **위험 감지** | 고열 38도만 | 5가지 복합 조건 + 단계별 대응 |
| **개인화** | 없음 | 이전 대화 기억 + 연속성 있는 코칭 |
| **근거 제시** | 없음 | "데이터를 분석해보니..." + 의학적 출처 |
| **권장 수유량** | 고정값 | 아기 체중 기반 동적 계산 |
| **시간대 고려** | 없음 | 영아 산통 호발 시간 등 시간대별 조언 |

---

## 테스트 체크리스트

### ✅ 정상 상태
- [x] 일반적인 밤잠 깨어남 → CoT 추론 → 적절한 조언
- [x] 개인화 컨텍스트 포함 확인
- [x] "데이터를 분석해보니..." 논리적 근거 포함

### ✅ 배고픔 감지
- [x] 수유 간격 3.5시간 → 배고픔 가설 생성
- [x] 수유량 80ml (권장 110ml) → 부족 판단
- [x] 권장 수유량 체중 기반 동적 계산

### ✅ 위험 상태
- [x] 체온 38.5°C → Critical 모드
- [x] 수유량 40% 감소 → Critical 모드
- [x] PDF 리포트 버튼 표시

### ✅ 수면 압력
- [x] 각성 120분 (권장 75분) → 과자극 판단
- [x] 각성 30분 → 수면 압력 부족 판단

### ✅ 영아 산통
- [x] 저녁 19시 + 생후 72일 → 산통 가설
- [x] 5S 기법 조언 제공

### ✅ 개인화
- [x] "안아줘야 자요" 언급 → 자동 저장
- [x] 다음 상담 시 "지난번에 말씀하신..." 참조

---

## 결론

모든 요구사항이 완벽히 구현되었습니다:

✅ 20년 경력 전문가 페르소나
✅ AAP/WHO 가이드라인 기반
✅ 생후 72일 발달 특징 반영
✅ 다각도 상관관계 분석 (수유/건강/수면압력/시간대)
✅ Chain of Thought 4단계 투명한 추론
✅ 5가지 위험 징후 필터링
✅ 개인화 메모리 + 연속성 코칭
✅ "데이터를 분석해보니..." 논리적 근거 제시

부모는 이제 단순한 AI가 아닌, **진짜 전문가의 조언**을 받는 경험을 하게 됩니다.
